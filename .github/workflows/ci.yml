name: CI - Test & Build Kollegen App

on:
  push:
    branches-ignore: [ "main" ] # CI läuft auf allen Dev-Branches
  pull_request:
    branches: [ "main" ] # CI läuft für alle PRs zu main

jobs:
  # ------------------------------------
  # FRONTEND JOB (Vue)
  # ------------------------------------
  frontend-check:
    runs-on: ubuntu-latest
    # Prüft nur, wenn 'Frontend/' betroffen ist
    if: github.event_name == 'pull_request' || contains(github.event.head_commit.modified, 'Frontend/') 
    defaults:
      run:
        # Festlegen des Arbeitsverzeichnisses
        working-directory: ./Frontend 

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: './Frontend/package-lock.json' 

      - name: Install Dependencies
        run: npm ci

      - name: Build Test
        run: npm run build # Wichtig: Prüft auf Build-Fehler und Kompilierprobleme

      # Falls vorhanden, hier die Unit Tests einfügen
      # - name: Run Unit Tests
      #   run: npm test

  # ------------------------------------
  # BACKEND JOB (Node + MariaDB)
  # ------------------------------------
  backend-check:
    runs-on: ubuntu-latest
    # Prüft nur, wenn 'Backend/' betroffen ist
    if: github.event_name == 'pull_request' || contains(github.event.head_commit.modified, 'Backend/')
    defaults:
      run:
        # Festlegen des Arbeitsverzeichnisses
        working-directory: ./Backend

    # MariaDB wird als Service Container gestartet
    services:
      mariadb:
        image: mariadb:10.6
        env:
          MYSQL_ROOT_PASSWORD: testpassword
          MYSQL_DATABASE: kollegen_test_db
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: './Backend/package-lock.json' 

      - name: Install Dependencies
        run: npm ci

      - name: Wait for DB to be ready
        # Wartet, bis der MariaDB-Servicecontainer betriebsbereit ist
        run: |
          for i in $(seq 1 10); do
            if mysqladmin ping -h 127.0.0.1 -u root --password=testpassword --silent; then
              echo "MariaDB is ready."
              break
            fi
            sleep 1
          done

      - name: Run Backend Tests
        run: npm test # Führt alle Backend-Tests aus (z.B. Jest, Mocha)
        env:
          # Umgebungsvariablen für die Verbindung zum Service Container
          DB_HOST: 127.0.0.1
          DB_USER: root
          DB_PASS: testpassword
          DB_NAME: kollegen_test_db