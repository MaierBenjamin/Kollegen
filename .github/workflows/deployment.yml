name: Kollegen Deployment Pipeline

on:
  push:
    branches:
      - main   # Deployment nur auf main

jobs:
  deploy:
    runs-on: ubuntu-latest
    # Deployment soll erst laufen, wenn alle Tests erfolgreich sind
    # (Optional: kann man Ã¼ber Workflow-Dispatch Trigger steuern oder ein CI-Status-Check einbauen)
    steps:
      - name: Download Frontend Build Artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: dist

      - name: Checkout Repository (Backend)
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

      # Deployment Frontend
      - name: Deploy Frontend Files
        run: |
          rsync -avz dist/ ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/var/www/kollegen-frontend/

      # Deployment Backend
      - name: Deploy Backend Files
        run: |
          rsync -avz Backend/ ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/var/www/kollegen-backend/

      # Backend neu starten
      - name: Restart Backend Service
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "
            cd /var/www/kollegen-backend && 
            npm install --production &&
            pm2 restart kollegen || pm2 start src/server.js --name kollegen
          "
